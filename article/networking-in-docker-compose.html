<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>透過 Docker Compose 設定 network | Titangene Blog</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="author" content="Titangene"><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" href="/atom.xml" title="Titangene Blog"><meta name="description" content="Docker Compose 預設會建立 default network，這篇會告訴你如何自訂 network、如何使用現有的 network，以及如何自訂 network 名稱。"><meta name="keywords" content="Docker,Container,Docker Compose"><meta property="og:type" content="article"><meta property="og:title" content="透過 Docker Compose 設定 network"><meta property="og:url" content="https://titangene.github.io/article/networking-in-docker-compose.html"><meta property="og:site_name" content="Titangene Blog"><meta property="og:description" content="Docker Compose 預設會建立 default network，這篇會告訴你如何自訂 network、如何使用現有的 network，以及如何自訂 network 名稱。"><meta property="og:locale" content="zh-tw"><meta property="og:image" content="https://titangene.github.io/images/cover/docker-compose.jpg"><meta property="og:updated_time" content="2019-05-15T13:02:26.117Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="透過 Docker Compose 設定 network"><meta name="twitter:description" content="Docker Compose 預設會建立 default network，這篇會告訴你如何自訂 network、如何使用現有的 network，以及如何自訂 network 名稱。"><meta name="twitter:image" content="https://titangene.github.io/images/cover/docker-compose.jpg"><meta name="twitter:creator" content="@titangeneTW"><meta name="twitter:site" content="@titangene_blog"><meta property="fb:admins" content="100001106016019"><meta property="fb:app_id" content="2470546159839111"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="google-site-verification" content="AaJ39L7h-nWwJjXJMhAMtXSF6H6BUgGWXC80kYvLic8"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Inconsolata|Titillium+Web"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet"><link rel="stylesheet" href="//use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous"><link rel="stylesheet" href="/style.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129758206-1"></script><script>!function(a){function n(){dataLayer.push(arguments)}a.dataLayer=a.dataLayer||[],n("js",new Date),n("config","UA-129758206-1")}(window)</script><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script></head><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>setLoadingBarProgress(20)</script><header class="l_header"><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/">Titangene Blog</a><div class="menu"><ul class="h-list"><li><a class="flat-box nav-home" href="/">Home</a></li><li><a class="flat-box nav-archives" href="/archives">Archives</a></li></ul><div class="underline"></div></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <i class="fas fa-search"></i></form></div><ul class="switcher h-list"><li class="s-search"><a class="fas fa-search" href="javascript:void(0)"></a></li><li class="s-menu"><a class="fas fa-bars" href="javascript:void(0)"></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo flat-box" href="/">Titangene Blog</a><ul class="switcher h-list"><li class="s-comment"><a class="far fa-comment-alt" href="javascript:void(0)"></a></li><li class="s-top"><a class="fas fa-arrow-up" href="javascript:void(0)"></a></li><li class="s-toc"><a class="fas fa-list-ol" href="javascript:void(0)"></a></li></ul></div></div></header><aside class="menu-phone"><nav><a href="/" class="nav-home nav">Home </a><a href="/archives" class="nav-archives nav">Archives</a></nav></aside><script>setLoadingBarProgress(40)</script><div class="l_body"><div class="container clearfix"><div class="l_main"><article id="post-networking-in-docker-compose" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><h2 class="title"><a href="/article/networking-in-docker-compose.html">透過 Docker Compose 設定 network</a></h2><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar"></i> </span><span class="post-meta-item-text">發表於</span> <time title="建立時間：2019-05-15 21:03:15" itemprop="dateCreated datePublished" datetime="2019-05-15T21:03:15+08:00">2019-05-15</time></span> <span class="comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fas fa-comment"></i> </span><a href="https://titangene.github.io/article/networking-in-docker-compose.html#disqus_thread" class="article-comment-count" data-disqus-identifier="article/networking-in-docker-compose.html" itemprop="discussionUrl"></a></span><div class="post-category"><span class="post-meta-item-icon"><i class="fa fa-folder"></i> </span><span class="post-meta-item-text">分類於</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a></span></div></section><section class="toc-wrapper"><h3>目錄</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#更新容器"><span class="toc-text">更新容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Links"><span class="toc-text">Links</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multi-host-networking"><span class="toc-text">Multi-host networking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#指定自定-network"><span class="toc-text">指定自定 network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#設定-default-network"><span class="toc-text">設定 default network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-pre-existing-network"><span class="toc-text">使用 pre-existing network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自訂-network-名稱"><span class="toc-text">自訂 network 名稱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#參考來源"><span class="toc-text">參考來源</span></a></li></ol></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p><img src="../images/cover/docker-compose.jpg" alt></p><p>Docker Compose 預設會建立 default network，這篇會告訴你如何自訂 network、如何使用現有的 network，以及如何自訂 network 名稱。</p><a id="more"></a><p>Docker Compose 預設會幫你的應用程式設定一個 network，service 的每個容器都會加入 default network，並且該 network 上的其他容器都可以連接 (reachable) 以及發現 (discoverable) 與容器名稱相同的 hostname。</p><p>預設的 network 名稱是基於 “專案目錄名稱”，並加上 <code>_default</code>。例如：你的應用程式放在名為 <code>myapp</code> 的專案目錄中，而 <code>docker-compose.yml</code> 的內容如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">'8000:8000'</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">'8001:5432'</span><br></code></pre></td></tr></tbody></table></figure><p>當你執行 <code>docker-compose up</code> 指令時，會發生以下情況：</p><ol><li>建立一個名為 <code>myapp_default</code> 的 network</li><li>使用 <code>web</code> 的設定建立容器，並以 <code>web</code> 這個名稱加入名為 <code>myapp_default</code> 的 network</li><li>使用 <code>db</code> 的設定建立容器，並以 <code>db</code> 這個名稱加入名為 <code>myapp_default</code> 的 network</li></ol><div class="info"><p>當然你也可以使用 <a href="https://docs.docker.com/compose/reference/overview/" target="_blank" rel="noopener"><code>--project-name</code> (可簡寫成 <code>-p</code> ) 參數</a> 或使用 <code>COMPOSE_PROJECT_NAME</code> 這個 <a href="https://docs.docker.com/compose/reference/envvars/#compose-project-name" target="_blank" rel="noopener">環境變數</a> 來複寫專案名稱。</p></div><p>現在，每個容器都可以找到名為 <code>web</code> 或 <code>db</code> 的 hostname，並獲得對應容器的 IP 位址。例如：<code>web</code> 的應用程式的程式碼可以連接到 <code>postgres://db:5432</code> 的 URL，並開始使用 Postgres 資料庫。</p><p>不過要注意 <code>HOST_PORT</code> 和 <code>CONTAINER_PORT</code> 之間的差別。以上面範例中的 <code>db</code> 來說，<code>HOST_PORT</code> 是 <code>8001</code>，<code>CONTAINER_PORT</code> 是 <code>5432</code> (postgres 的預設 port)。Networked service-to-service 通訊使用 <code>CONTAINER_PORT</code>。定義 <code>HOST_PORT</code> 之後，service 也可以在 swarm 外部存取。</p><p>在 <code>web</code> 的容器中，如果要連接到 <code>db</code> 的連接字串會看起來像是 <code>postgres://db:5432</code> 這樣，而從 host machine 來看，連接字串看起來像是 <code>postgres://{DOCKER_IP}:8001</code>。</p><h2 id="更新容器"><a class="header-anchor" href="#更新容器"></a>更新容器</h2><p>如果有變更 service 的設定，請執行 <code>docker-compose up</code> 指令來更新 service，它會刪除舊的容器，而新容器會以不同的 IP 位址加入相同名稱的 network。執行中的容器可以找到該名稱並連接到新的 IP 位址，而舊的 IP 位址就無法使用。</p><p>如果任何容器對舊容器開放連線，那這些容器就會被關閉連線。容器有責任檢測這個情況，再次找到名稱並重新連接。</p><h2 id="Links"><a class="header-anchor" href="#Links"></a>Links</h2><p>link 到另一個 service 中的容器。透過 link 可以指定 service 名稱和 link 別名 ( <code>SERVICE:ALIAS</code> ），或僅指定 service 名稱。透過該別名可以從其他 service 存取到 service。link 不需要啟用 service 進行通訊 - 預設情況下，任何 service 都可以通過該 service 的名稱存取任何其他 service。</p><p>鏈接 (linked) service 的容器可在別名相同的 hostname 上存取，如果未指定別名，則可以存取 service 名稱。</p><p>在下面範例中，可以從 <code>web</code> 的 hostname <code>db</code> 和 <code>database</code> 存取到 <code>db</code>：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">'db:database'</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span><br></code></pre></td></tr></tbody></table></figure><p><code>link</code> 和 <a href="https://docs.docker.com/compose/compose-file/#depends_on" target="_blank" rel="noopener"><code>depends_on</code></a> 都是以相同的方式表達 service 之間的依賴關係，因此可以使用它們來決定 service 啟動的順序。</p><div class="info"><ul><li>如果同時定義 <code>links</code> 和 <code>networks</code>，則它們之間具有 <code>links</code> 的 service 必須共享至少一個共同的網絡才能進行通訊。建議使用 network</li><li><a href="https://docs.docker.com/engine/reference/commandline/stack_deploy/" target="_blank" rel="noopener">在 swarm 模式下使用 Compose 檔案 (v3) 部署 stack 時</a>，會忽略 <code>links</code> 這個 option</li></ul></div><div class="warning"><p><code>--link</code> 參數為 legacy 功能，可能會被刪除。不建議使用 <code>--link</code>，建議使用 <a href="https://docs.docker.com/network/" target="_blank" rel="noopener">user-defined networks</a> (使用者定義的網路) 來促成兩個容器之間的溝通。user-defined networks 不支援你用 <code>--link</code> 參數在容器之間共享環境變數。但是，你可以使用其他機制 (例如：volume)，以更可控的方式在容器之間共享環境變數。</p></div><blockquote><p>詳情可參考官方的 <a href="https://docs.docker.com/compose/compose-file/#links" target="_blank" rel="noopener">Compose file version 3 reference | Docker Documentation</a> 文件。</p></blockquote><h2 id="Multi-host-networking"><a class="header-anchor" href="#Multi-host-networking"></a>Multi-host networking</h2><div class="info"><p>注意：本節中的說明只適用於 <a href="https://docs.docker.com/compose/swarm/" target="_blank" rel="noopener">legacy Docker Swarm</a> 的相關操作，並且只有目標為 legacy Swarm 叢集才有用。有關將 compose 專案部署至較新的整合 swarm mode，請參考<a href="https://docs.docker.com/compose/bundles/" target="_blank" rel="noopener">Docker Stacks</a> 文件。</p></div><p>將 <a href="https://docs.docker.com/compose/swarm/" target="_blank" rel="noopener">Compose 應用程式部署至 Swarm 叢集</a> 時，可以使用內建的 <code>overlay</code> driver 在容器之間啟用 multi-host 通訊，而無需更改 Compose 檔案或應用程式的程式碼。</p><p>想了解如何設定 Swarm 叢集可參考官方的 <a href="https://docs.docker.com/network/overlay-standalone.swarm/" target="_blank" rel="noopener">Multi-host networking</a> 這篇。叢集預設是使用 <code>overlay</code> driver，不過也可以參考下一節指定其他 driver。</p><h2 id="指定自定-network"><a class="header-anchor" href="#指定自定-network"></a>指定自定 network</h2><p>若不想使用預設的 app network，可以使用 <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference" target="_blank" rel="noopener">top-level <code>networks</code> key</a> 來指定自己的 network，讓你可以建立更複雜的拓撲，並指定 <a href="https://docs.docker.com/engine/extend/plugins_network/" target="_blank" rel="noopener">custom network driver</a> 和 option。還可以使用它，將 service 連接到不由 Compose 管理，而是由外部建立的 network。</p><p>每個 service 都可以使用 <a href="https://docs.docker.com/compose/compose-file/#networks" target="_blank" rel="noopener">service-level <code>networks</code> key</a> 指定要連接的 network，該 key 是引用至 <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference" target="_blank" rel="noopener">top-level <code>networks</code> key</a> 下的名稱。</p><p>以下面定義的兩個自定 network 的 Compose 檔案為例，<code>proxy</code> service 與 <code>db</code> service 隔離，因為它們不共享共同的 network，只有 <code>app</code> 可以與兩者溝通：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">proxy:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./proxy</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">frontend</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./app</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">frontend</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">backend</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">backend</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">frontend:</span><br>    <span class="hljs-comment"># Use a custom driver</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">custom-driver-1</span><br>  <span class="hljs-attr">backend:</span><br>    <span class="hljs-comment"># Use a custom driver which takes special options</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">custom-driver-2</span><br>    <span class="hljs-attr">driver_opts:</span><br>      <span class="hljs-attr">foo:</span> <span class="hljs-string">'1'</span><br>      <span class="hljs-attr">bar:</span> <span class="hljs-string">'2'</span><br></code></pre></td></tr></tbody></table></figure><p>通過為每個連接 (attached) 的 network 設定 <a href="https://docs.docker.com/compose/compose-file/#ipv4_address-ipv6_address" target="_blank" rel="noopener"><code>ipv4_address</code> 和/或 <code>ipv6_address</code></a>，可以為 network 設定靜態 IP 位址。</p><h2 id="設定-default-network"><a class="header-anchor" href="#設定-default-network"></a>設定 default network</h2><p>透過在 top-level <code>networks</code> key 內，名為 <code>default</code> network 下定義 entry，來更改應用程序範圍 (app-wide) 的 default network 的設定：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">'8000:8000'</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-comment"># Use a custom driver</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">custom-driver-1</span><br></code></pre></td></tr></tbody></table></figure><h2 id="使用-pre-existing-network"><a class="header-anchor" href="#使用-pre-existing-network"></a>使用 pre-existing network</h2><p>如果希望容器加入預先定義好的 network，就可以使用 <code>external</code> option。</p><p>如果 <code>external</code> 設為 <code>true</code>，就會指定已在 Compose 之外先建立的那個 network，所以 <code>docker-compose up</code> 不會嘗試建立此 network。</p><p>如果此 network 不存在，會因為找不到參考的目標 network 而發生錯誤。錯誤如下：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> docker-compose up</span><br>ERROR: Network my_network declared as external, but could be found. Please create the network manually using `docker network create my_network` and try again.<br></code></pre></td></tr></tbody></table></figure><p>如果找不到此 network，可以執行 <code>docker network create [network_name]</code> 來建立 network。</p><p>在 Compose v3.3 以及更舊版的檔案格式下，<code>external</code> 不能跟其他 network configuration keys 一起使用，包括：<code>driver</code>、<code>driver_opts</code>、<code>ipam</code> 和 <code>internal</code> 。Compose <a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-34" target="_blank" rel="noopener">v3.4</a> 以及更新版的格式就沒有這個限制。</p><p>下面範例的 Compose 會找到名為 <code>my-network-name</code> 的已存在的 network，並將應用程式的容器連接到該 network，這樣就不會嘗試建立一個名為 <code>[projectname]_default</code> 的 network：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.7"</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">whatever</span><br>  <span class="hljs-attr">networks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">my-network</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">my-network:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">my-network-name</span><br></code></pre></td></tr></tbody></table></figure><p>在下面範例中，<code>proxy</code> 是通往外部世界的 gateway，所以不需要建立一個名為 <code>[projectname]_outside</code> 的 network。Compose 會找到一個名為 <code>outside</code> 的已存在的 network，並將 <code>proxy</code> service 的容器連接到 <code>outside</code> network。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.7"</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">proxy:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./proxy</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">outside</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./app</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">default</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">outside:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></tbody></table></figure><p>下面範例的 Compose 不會嘗試建立一個名為 <code>[projectname]_default</code> 的 network，Compose 會找到名為 <code>my-pre-existing-network</code> 的 network，並將應用程式的容器連接到該 network。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.7"</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">my-pre-existing-network</span><br></code></pre></td></tr></tbody></table></figure><div class="info"><p><code>external.name</code> 在 <a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-35" target="_blank" rel="noopener">Compose v3.5 檔案格式</a> 中已被棄用，請改用同版本新增的 <code>name</code>，下一節會說明。</p></div><h2 id="自訂-network-名稱"><a class="header-anchor" href="#自訂-network-名稱"></a>自訂 network 名稱</h2><p>network 也可以自訂名稱，<code>name</code> 屬性可引用包含特殊字元的 network。</p><p>下面以這個 Compose 為例，介紹如何自訂 network 名稱：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.5'</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">whatever</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">my-network</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">my-network:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">my-app-network</span><br></code></pre></td></tr></tbody></table></figure><p>在 <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference" target="_blank" rel="noopener">top-level <code>networks</code> key</a></p><ol><li>先把 Compose 裡面的 <code>version</code> 改成 3.5 以上，因為在 v3.5 版才開始提供自訂 network 名稱 (也就是增加 <code>name</code> 屬性)</li><li>在 <a href="https://docs.docker.com/compose/compose-file/#networks" target="_blank" rel="noopener">service-level <code>networks</code> key</a> 裡面 (也就是自訂的 service 內的 <code>networks</code> )，加入自訂的 network 名稱 (此範例為 <code>my-network</code> )</li><li>network 的詳細定義是寫在 <a href="https://docs.docker.com/compose/compose-file/#network-configuration-reference" target="_blank" rel="noopener">top-level <code>networks</code> key</a> (也就是通常寫在檔案最後面的 <code>networks</code> ) 裡面。這裡的 network 名稱要和 service-level <code>networks</code> key 裡面自訂的名稱對應 (也就是 <code>my-network</code> 這個 network 名稱要和上面 <code>services</code> 內的一樣)，在 <code>my-network</code> 下面就可以使用 <code>name</code> 屬性來自定 network 名稱 ( <code>my-app-network</code> 就是你真正自訂的 network 名稱 )</li></ol><blockquote><p>詳情可參考官方的 <a href="https://docs.docker.com/compose/compose-file/#name-1" target="_blank" rel="noopener">Compose file version 3 reference | Docker Documentation</a> 文件。</p></blockquote><p>也可以與 <code>external</code> 屬性一起使用：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.7"</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">network1:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">my-app-network</span><br></code></pre></td></tr></tbody></table></figure><h2 id="參考來源"><a class="header-anchor" href="#參考來源"></a>參考來源</h2><ul><li><a href="https://docs.docker.com/compose/networking" target="_blank" rel="noopener">Networking in Compose | Docker Documentation</a></li><li><a href="https://docs.docker.com/compose/compose-file" target="_blank" rel="noopener">Compose file version 3 reference | Docker Documentation</a></li></ul></div><div class="article-tags tags"><a href="/tags/docker/" title="Docker">Docker</a> <a href="/tags/container/" title="Container">Container</a> <a href="/tags/docker-compose/" title="Docker Compose">Docker Compose</a></div></section><div class="article-share-links"><span>分享：</span> <a class="fab fa-facebook-f" title="Facebook" target="_blank" href="javascript:window.open('https://www.facebook.com/sharer.php?u=https%3A%2F%2Ftitangene.github.io%2Farticle%2Fnetworking-in-docker-compose.html', 'Share on Facebook','width=600, height=600')"></a> <a class="fab fa-twitter" title="Twitter" target="_blank" href="javascript:window.open('https://twitter.com/share?url=https%3A%2F%2Ftitangene.github.io%2Farticle%2Fnetworking-in-docker-compose.html&text=透過 Docker Compose 設定 network&hashtags=Docker,Container,DockerCompose&via=titangene_blog', 'Share on Twitter','width=600, height=260')"></a> <a class="fab fa-linkedin-in" title="Linkedin" target="_blank" href="javascript:window.open('https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Ftitangene.github.io%2Farticle%2Fnetworking-in-docker-compose.html&title=透過 Docker Compose 設定 network', 'Share on Linkedin','width=600, height=600')"></a> <a class="fab fa-facebook-messenger" title="Facebook Messenger" target="_blank" href="javascript:window.open('http://www.facebook.com/dialog/send?app_id=2470546159839111&link=https%3A%2F%2Ftitangene.github.io%2Farticle%2Fnetworking-in-docker-compose.html&display=popup&redirect_uri=https%3A%2F%2Fwww.facebook.com%2Fdialog%2Freturn%2Fclose%23_%3D_', 'Send in Messenger','width=600, height=600')"></a> <a class="fab fa-telegram-plane" href="https://telegram.me/share/url?url=https%3A%2F%2Ftitangene.github.io%2Farticle%2Fnetworking-in-docker-compose.html&text=透過 Docker Compose 設定 network" target="_blank"></a></div><nav id="article-nav"><a href="/article/gcp-network-and-http-load-balancer.html" id="article-nav-prev" class="article-nav-link-wrap" title="在 GCP 建立 Network Load Balancer 和 HTTP Load Balancer" rel="prev"><strong class="article-nav-caption">Prev</strong><p class="article-nav-title">在 GCP 建立 Network Load Balancer 和 HTTP Load Balancer</p><i class="fas fa-angle-left"></i> </a><a href="/article/hackmd-dark-theme.html" id="article-nav-next" class="article-nav-link-wrap" title="套用自訂 HackMD 暗主題" rel="next"><strong class="article-nav-caption">Next</strong><p class="article-nav-title">套用自訂 HackMD 暗主題</p><i class="fas fa-angle-right"></i></a></nav><section id="list_related_posts"><h2>相關文章</h2><ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/article/docker-mssql-server-for-linux.html">在 Docker 下建立並使用 MSSQL Server for Linux</a><div class="related-posts-item-abstract">在 SQL Server 2017 時，微軟推出了 Linux 版，同時也在 Docker Hub 上提供了 microsoft/mssql-server-linux 的 Docker image。本篇會介紹如何在 Do</div></li><li class="related-posts-item"><a class="related-posts-link" href="/article/getting-started-with-google-k8s-engine.html">Google Kubernetes Engine (GKE) 入門</a><div class="related-posts-item-abstract">本篇是紀錄在 Google 的 Qwiklab 平台內，完成「Kubernetes Engine: Qwik Start」這個 quest 所學到的內容，包括如何透過 GKE 建立容器和部署容器化應用程式。Google</div></li></ul></section><section class="comments" id="comments"><h2>討論區</h2><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script>window.subData={title:"透過 Docker Compose 設定 network",tools:!0}</script></div><aside class="l_side"><section class="m_widget about"><div class="avatar-section"><style>.avatar-cover{background:url(/images/avatar_cover.jpg) 0 10%/cover no-repeat}</style><div class="avatar-cover"></div><img class="avatar" src="/images/avatar.jpg"></div><div class="header">Titangene</div><div class="content"><div class="desc">利用 blog 紀錄學習歷程</div></div><div class="content"><meta itemprop="url" content="https://titangene.github.io"><div class="social-wrapper"><a itemprop="sameAs" href="https://github.com/titangene" class="social github" target="_blank" rel="external"><span class="fab fa-github-alt"></span> </a><a itemprop="sameAs" href="https://www.facebook.com/titangene.tw" class="social facebook" target="_blank" rel="external"><span class="fab fa-facebook-square"></span> </a><a itemprop="sameAs" href="https://www.instagram.com/titangene/" class="social instagram" target="_blank" rel="external"><span class="fab fa-instagram"></span> </a><a itemprop="sameAs" href="https://www.flickr.com/photos/titangene" class="social flickr" target="_blank" rel="external"><span class="fab fa-flickr"></span> </a><a itemprop="sameAs" href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="fas fa-rss"></span></a></div></div></section><section class="m_widget facebook_page"><div class="fb-page" data-href="https://www.facebook.com/titangene.blog/" data-width="250" data-small-header="false" data-adapt-container-width="false" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/titangene.blog/" class="fb-xfbml-parse-ignore"><p><a href="https://www.facebook.com/titangene.blog/" class="social facebook" target="_blank"><span class="fab fa-facebook-square"></span></a></p><p><a href="https://www.facebook.com/titangene.blog/">Titangene Blog</a></p><p>Loading...</p></blockquote></div></section><section class="m_widget recent"><div class="header">Recents</div><div class="content"><ul class="entry"><li><a itemprop="url" class="flat-box" href="/article/git-commit-object.html"><time>2020-03-15</time><div class="name">深入 Git：Git 物件儲存 - commit 物件</div></a></li><li><a itemprop="url" class="flat-box" href="/article/git-index.html"><time>2020-03-08</time><div class="name">深入 Git：index 檔案</div></a></li><li><a itemprop="url" class="flat-box" href="/article/git-tree-object.html"><time>2020-03-01</time><div class="name">深入 Git：Git 物件儲存 - tree 物件</div></a></li><li><a itemprop="url" class="flat-box" href="/article/git-auto-crlf.html"><time>2020-02-23</time><div class="name">處理 Git 斷行字元的問題</div></a></li><li><a itemprop="url" class="flat-box" href="/article/git--blob-object.html"><time>2020-02-16</time><div class="name">深入 Git：Git 物件儲存 - blob 物件</div></a></li></ul></div></section></aside><script>setLoadingBarProgress(60)</script></div></div><footer id="footer" class="clearfix"><div class="social-wrapper"><a href="https://github.com/titangene" class="social github" target="_blank" rel="external"><span class="fab fa-github-alt"></span> </a><a href="https://www.facebook.com/titangene.tw" class="social facebook" target="_blank" rel="external"><span class="fab fa-facebook-square"></span> </a><a href="https://www.instagram.com/titangene/" class="social instagram" target="_blank" rel="external"><span class="fab fa-instagram"></span> </a><a href="https://www.flickr.com/photos/titangene" class="social flickr" target="_blank" rel="external"><span class="fab fa-flickr"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="fas fa-rss"></span></a></div><div>© 2018 - 2020 <span itemprop="copyrightHolder">Titangene</span></div><div>Powered by <a href="https://hexo.io/" class="codename" rel="external">Hexo</a> - Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename" rel="external">MaterialFlow</a></div><div><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a></div></footer><script>setLoadingBarProgress(80)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script>var SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script>var disqus_shortname="titangene-blog",disqus_config=function(){this.page.url="https://titangene.github.io/article/networking-in-docker-compose.html",this.page.identifier="article/networking-in-docker-compose.html",this.page.title="透過 Docker Compose 設定 network"};!function(){var e=document.createElement("script");e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",e.setAttribute("data-timestamp",""+new Date),(document.head||document.body).appendChild(e)}()</script><script id="dsq-count-scr" src="https://titangene-blog.disqus.com/count.js" async></script><div id="fb-root"></div><script>window.fbAsyncInit=function(){FB.init({appId:"2470546159839111",autoLogAppEvents:!0,xfbml:!0,version:"v2.11"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/zh_TW/sdk.js",s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script>setLoadingBarProgress(100)</script><script type="text/javascript" src="/js/bundle.js"></script></body></html>